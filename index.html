<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1, minimum-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">

    <link rel="manifest" href="manifest.json" />
    <link rel="stylesheet" href="style.css" />
    <title>PWA Fullscreen Test</title>
  </head>
  <body>
    <div id="safe-area"></div>
    <pre id="bit-text"></pre>
    <canvas id="canvas"></canvas>
    <script>
      const isPwaMode = getIsPwaMode();
      const canvas = document.getElementById('canvas');      

      function resizeCanvasToDiv() {
        let width, height;
        if (isPwaMode) {
          width = window.screen.width;
          height = window.screen.height;
        } else {
          width = window.innerWidth;
          height = window.innerHeight;
        }

        const dpr = window.devicePixelRatio || 1;
        const safeArea = document.getElementById('safe-area');
        const sat = getComputedStyle(safeArea).getPropertyValue('top');
        const sar = getComputedStyle(safeArea).getPropertyValue('right');
        const sab = getComputedStyle(safeArea).getPropertyValue('bottom');
        const sal = getComputedStyle(safeArea).getPropertyValue('left');

        const pwaModeLine = (isPwaMode ? 'PWA mode: true' : 'PWA mode: false') + `\n${width}x${height}`;
        const dprLine = `dpr: ${dpr}`;
        const safeAreaLine = `sat: ${sat}, sar: ${sar}, sab: ${sab}, sal: ${sal}`;
        document.getElementById('bit-text').textContent = [pwaModeLine, dprLine, safeAreaLine].join('\n');

        // 设置 canvas 绘图表面的实际宽度和高度，考虑设备像素比
        canvas.width = width * dpr;
        canvas.height = height * dpr;

        // 调整 canvas 的 CSS 尺寸以匹配显示尺寸
        canvas.style.width = `${width}px`;
        canvas.style.height = `${height}px`;

        drawContent(pxToNumber(sat) * dpr, pxToNumber(sar) * dpr, pxToNumber(sab) * dpr, pxToNumber(sal) * dpr);
      }

      // 页面加载时调整一次尺寸
      requestAnimationFrame(resizeCanvasToDiv);

      // 监听窗口大小变化事件，实时调整 canvas 尺寸
      window.addEventListener('resize', resizeCanvasToDiv);

      function drawContent(sat, sar, sab, sal) {
        const ctx = canvas.getContext('2d');
        ctx.strokeStyle = 'yellow';
        ctx.lineWidth = 10;
        ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);

        const safeAreaWidth = canvas.width - (sal + sar);
        const safeAreaHeight = canvas.height - (sat + sab);
        
        // 绘制半透明蓝色方块
        ctx.fillStyle = 'rgba(0, 0, 255, 0.3)';
        ctx.fillRect(
          sal,
          sat,
          safeAreaWidth,
          safeAreaHeight
        );

        // 左下角绘制文字 test
        ctx.fillStyle = 'white';
        ctx.font = '20px Arial';
        ctx.imageSmoothingEnabled = false;  // 关闭抗锯齿
        ctx.textRendering = 'pixelated';    // 像素化渲染
        ctx.fillText('test', 10, canvas.height / 2);

        // 屏幕中间 10px * 10px 区域绘制纱窗状的白色像素点
        const centerX = Math.floor(canvas.width / 2);
        const centerY = Math.floor(canvas.height / 2);
        ctx.fillStyle = 'white';
        for (let i = 0; i < 10; i++) {
          for (let j = 0; j < 10; j++) {
            if ((i + j) % 2 === 0) {
              ctx.fillRect(centerX - 5 + i, centerY - 5 + j, 1, 1);
            }
          }
        }
      }

      function getIsPwaMode() {
        if (window.navigator.standalone) {
          return true;
        }
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('pwa') === 'true';
      }

      function pxToNumber(px) {
        return parseInt(px.replace('px', ''));
      }
      
    </script>
  </body>
</html>
